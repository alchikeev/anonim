#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –ø—Ä–æ–µ–∫—Ç–∞ "–ê–Ω–æ–Ω–∏–º –ú–µ–∫—Ç–µ–ø" –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –ø—Ä–æ–µ–∫—Ç–∞ '–ê–Ω–æ–Ω–∏–º –ú–µ–∫—Ç–µ–ø'..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -f ".env.prod" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª .env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env.prod –Ω–∞ –æ—Å–Ω–æ–≤–µ env.example"
    exit 1
fi

if [ ! -f "docker-compose.caddy.yml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª docker-compose.caddy.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@79.133.181.227 "mkdir -p /root/anonim-mektep"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' --exclude='venv' --exclude='.env.dev' . root@79.133.181.227:/root/anonim-mektep/

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è volumes –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìÇ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è Docker volumes..."
ssh root@79.133.181.227 "mkdir -p /var/lib/docker/volumes/anonim_static_data/_data /var/lib/docker/volumes/anonim_media_data/_data"

# –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
ssh root@79.133.181.227 "cd /root/anonim-mektep && docker-compose -f docker-compose.caddy.yml up -d --build"

# –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ Caddy
echo "üîß –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ Caddy..."
ssh root@79.133.181.227 "cd /root/anonim-mektep && chmod +x integrate_caddy.sh && ./integrate_caddy.sh"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Caddy –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Caddy..."
ssh root@79.133.181.227 "docker restart tdp-caddy-1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
ssh root@79.133.181.227 "docker ps | grep anonim"

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://anonim-m.online"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ssh root@79.133.181.227 'docker logs anonim-mektep_anonim_web_1'"
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ssh root@79.133.181.227 'cd /root/anonim-mektep && docker-compose -f docker-compose.caddy.yml restart'"
echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ssh root@79.133.181.227 'cd /root/anonim-mektep && docker-compose -f docker-compose.caddy.yml down'"
